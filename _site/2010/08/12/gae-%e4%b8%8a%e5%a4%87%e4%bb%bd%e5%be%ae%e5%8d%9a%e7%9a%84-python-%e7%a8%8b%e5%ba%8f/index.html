<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>GAE 上备份微博的 Python 程序</title>
   <meta name="author" content="Tao Zhang" />
   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
   <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-5531632-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

   </script>
</head>
<body>
<div id="page">
  <p id="breadcrumbs">
<a href="/">主页</a>
&rsaquo; <a href="/archive/">存档</a>
&rsaquo; GAE 上备份微博的 Python 程序
</p>
<article>
<header>
<h2><a title="Permalink to GAE 上备份微博的 Python 程序" href="http://ztnote.com/2010/08/12/gae-%25e4%25b8%258a%25e5%25a4%2587%25e4%25bb%25bd%25e5%25be%25ae%25e5%258d%259a%25e7%259a%2584-python-%25e7%25a8%258b%25e5%25ba%258f">GAE 上备份微博的 Python 程序</a></h2>
<time datetime="2010-08-12" pubdate="pubdate">Aug 12 2010</time>

| <a href="/category#WordPressBackup">WordPressBackup</a>

</header>
<p>注：普通验证方法，twitter8月16号就只能用Oauth了</p>

<p>程序目的：每天定时将当天发布的微博整理下来发送到邮箱</p>

<p>主程序：</p>

<pre lang="python">
#!/usr/bin/python
# -*- coding: utf-8 -*-
import urllib2
from datetime import datetime, date, time
import base64
import cgi
from google.appengine.api import mail
from google.appengine.ext import db #如果你要存到GAE数据库的话

try:
    from django.utils import simplejson  # GAE上使用json的方法
    parse_json = lambda s: simplejson.loads(s.decode("utf-8"))
except ImportError:
    import json #GAE 不支持 json
    parse_json = lambda s: json.load(s)

class Twitter(object):
    def __init__(self, nickname=None, password=None):
        self.nickname = nickname;
        self.password = password;
    def fetch_feed(self):
        request = urllib2.Request("请求地址，详情参阅twitter，新浪微博文档")
        if self.nickname and self.password
            pair = "%s:%s" % (self.nickname, self.password)
            token = base64.b64encode(pair)
            request.add_header("Authorization", "Basic %s" % token)

        stream = urllib2.urlopen(request)
        results = parse_json(stream.read())
        return results

def _fetchTweets():
    session = Twitter("你的id", "你的密码")
    feed = session.fetch_feed()
    html = "" #用来存放html版的结果然后发到Gmail

    #中间parse返回结果的代码就不写了，总之就是处理字符串

    if len(html)>0:
        mail.send_mail(sender="发送方email",
                to="接收方email",
                subject="标题",
                body="正文，上面这四个是必须参数，html则为html版正文",
                html=html.encode("utf-8"))

if __name__ == "__main__":
    _fetchTweets()
</pre>


<p>定义Cron Job的cron.yaml
cron:
- description: tweets backup
  url: /tweetsbackup/.*
  schedule: every day 00:00
  timezone: America/New_York</p>

<p>如果你想发送到wordpress或其他支持xmlrpc的blog，则可以参考以下代码（未经验证）：</p>

<pre lang="python">
import xmlrpclib
username = "admin"
password = "password"
blog_url = "blog地址"+"/xmlrpc.php"
title="TITLE OF POST"
content="内容"
wp = xmlrpclib.ServerProxy(blog_url)
post = {'title':title, 'description':content}
wp.metaWeblog.newPost('',username,password,post,1)
</pre>


<footer>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ztnote'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</footer>
</article>
</div>
<div id="footer">
<p id="followme">Follow me: <a href="https://twitter.com/#!/ztpala">Twitter</a> <a href="https://www.facebook.com/taozhang">Facebook</a> <a href="http://feeds.feedburner.com/pala">RSS</a> | Powered by <a href="https://github.com">GitHub</a> and <a href="https://github.com/mojombo/jekyll">Jekyll</a></p>
</div>
</body>
</html>
